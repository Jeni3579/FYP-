<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Live Threat Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .chart-container { position: relative; height: 40vh; width: 100%; }
        #alert-feed { height: 400px; overflow-y: scroll; font-size: 0.9rem; }
        .alert-feed-item { cursor: pointer; }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ url_for('it_staff.dashboard') }}">Back to Main Dashboard</a>
    <a href="{{ url_for('it_staff.logout') }}" class="btn btn-outline-danger">Logout</a>
  </div>
</nav>

<div class="container-fluid p-4">
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card"><div class="card-body">
                <h5 class="card-title">Live Event Analysis</h5>
                <div class="chart-container"><canvas id="threatChart"></canvas></div>
            </div></div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card"><div class="card-body">
                <h5 class="card-title">Live Security Alerts</h5>
                <p class="card-text text-muted small">Click on an alert for details.</p>
                <div id="alert-feed"></div>
            </div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="alertModalTitle">Alert Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="alertModalBody"></div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
  </div></div>
</div>

<script>
    const ctx = document.getElementById('threatChart').getContext('2d');
    const threatChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Normal', 'Potential Malware', 'Unauthorized Access', 'Ransomware Activity'],
            datasets: [{
                label: 'Event Count',
                data: [0, 0, 0, 0], // Initial counts
                backgroundColor: ['#198754', '#ffc107', '#fd7e14', '#dc3545'],
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    const alertFeed = document.getElementById('alert-feed');
    const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));

    function showDrillDown(details, severity, timestamp) {
        document.getElementById('alertModalTitle').innerText = `Alert Details - ${severity}`;
        document.getElementById('alertModalBody').innerText = `Time: ${timestamp}\n\nDetails:\n${details}`;
        alertModal.show();
    }

    function addAlertToFeed(alert) {
        const category = alert.prediction;
        if (category === 'Error') return;

        const severity = (category === 'Ransomware Activity') ? 'High' : (category === 'Normal') ? 'Info' : 'Medium';
        const alertColors = { Info: 'success', Medium: 'warning', High: 'danger' };
        const colorClass = alertColors[severity];

        if(category !== 'Normal') {
           const alertElement = document.createElement('div');
           alertElement.className = `alert alert-${colorClass} p-2 mb-2 alert-feed-item`;
           alertElement.innerHTML = `<strong>${alert.timestamp} [${category}]</strong>`;
           alertElement.onclick = () => showDrillDown(alert.details, severity, alert.timestamp);
           alertFeed.prepend(alertElement);
        }
        if (alertFeed.children.length > 20) alertFeed.lastChild.remove();
    }

    function updateDashboard() {
        fetch("{{ url_for('it_staff.live_threat_feed') }}")
            .then(res => res.json())
            .then(data => {
                const counts = threatChart.data.datasets[0].data;
                const labels = threatChart.data.labels;
                const index = labels.indexOf(data.prediction);
                if (index > -1) {
                    counts[index]++;
                    threatChart.update();
                }
                addAlertToFeed(data);
            });
    }

    setInterval(updateDashboard, 1000);
</script>
</body>
</html>